<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coolio</title>
<link rel="manifest" href="/static/manifest.webmanifest">
<style>
  body { margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(180deg,#f2f4f8,#e8ecf3); display:flex; justify-content:center; min-height:100vh; }
  .container { max-width:480px; width:100%; padding:24px; margin:auto; backdrop-filter: blur(20px); background: rgba(255,255,255,0.6); border-radius:24px; box-shadow:0 8px 20px rgba(0,0,0,0.1); }
  h1 { text-align:center; font-weight:600; color:#333; margin-bottom:24px; }
  input, button { font-size:1rem; margin:10px 0; border-radius:14px; border:none; box-shadow:0 1px 3px rgba(0,0,0,0.05); box-sizing:border-box; }
  input { background-color: rgba(255,255,255,0.8); border:1px solid #ccc; padding:14px 16px; width:100%; }
  input:focus { outline:none; border-color:#4facfe; box-shadow:0 0 6px #4facfe88; }
  button { background: linear-gradient(to right,#4facfe,#00f2fe); color:white; font-weight:600; cursor:pointer; transition:all 0.2s; padding:14px 16px; width:100%; }
  button:hover { opacity:0.95; }
  .produkt-liste { margin-top:24px; display:flex; flex-direction:column; gap:12px; }
  .produkt { background:white; padding:14px 18px; border-radius:16px; box-shadow:0 2px 6px rgba(0,0,0,0.06); font-size:1rem; color:#333; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .produkt:hover { background:#eef; }
  .leer { text-align:center; color:#999; margin-top:20px; }
  #reader { width:100%; margin-top:20px; border-radius:14px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  button.delete-btn { border:2px solid red; background:white; color:red; border-radius:14px; padding:6px 12px; cursor:pointer; font-weight:600; transition:all 0.2s; }
  button.delete-btn:hover { background:red; color:white; }
  /* Modal */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:20px; box-shadow:0 6px 16px rgba(0,0,0,0.3); width:90%; max-width:400px; text-align:center; animation:zoomIn 0.3s; }
  @keyframes zoomIn { from {transform:scale(0.8);} to {transform:scale(1);} }
  .close-btn { background:red; color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; margin-top:10px; }
  /* Plus-Button */
  #form { position:relative; } #barcode { padding-right:40px; }
  #manualBtn { position:absolute; right:8px; top:50%; transform:translateY(-50%); width:28px; height:28px; border-radius:50%; border:none; background:#4facfe; color:white; font-weight:bold; cursor:pointer; line-height:28px; }
  #manualName { display:none; margin-top:10px; width:100%; padding:14px 16px; border-radius:14px; border:1px solid #ccc; }
</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
<div class="container">
  {% if login %}
    <h1>Login</h1>
    {% if error %}<p style="color:red;">{{ error }}</p>{% endif %}
    <form method="POST">
      <input type="text" name="username" placeholder="Benutzername" required>
      <input type="password" name="password" placeholder="Passwort" required>
      <button type="submit">Login</button>
    </form>
  {% else %}
    <h1>üßä Mein K√ºhlschrank</h1>
    <p>Willkommen {{ user }}! <a href="{{ url_for('logout') }}">Logout</a></p>

    <form method="POST" id="form" style="margin-bottom:10px; position:relative;">
      <div style="position:relative; width:100%; height:48px;">
        <input type="text" id="barcode" name="barcode" placeholder="Barcode eingeben" autocomplete="off" style="width:100%; height:100%; padding:0 44px 0 16px; border-radius:14px; border:1px solid #ccc; box-sizing:border-box; font-size:16px; line-height:48px;" />
        <button type="button" id="manualBtn" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:50%; border:none; background:#4facfe; color:white; font-weight:bold; font-size:20px; cursor:pointer; display:flex; justify-content:center; align-items:center;">+</button>
      </div>
      <input type="text" id="manualName" name="manual_name" placeholder="Produktname eingeben" />
      <input type="date" name="ablauf" placeholder="Ablaufdatum" />
      <button type="submit" name="add">‚ûï Produkt hinzuf√ºgen</button>
    </form>

    <div id="reader"></div>

    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="suche" placeholder="Produkt suchen..." style="flex: 1;" />
      <button type="button" id="aiRecipeBtn" style="width: auto; padding: 14px 20px; white-space: nowrap; background: linear-gradient(to right, #ff6b6b, #ff8e53);">ü§ñ KI Rezept</button>
    </div>

    <div class="produkt-liste" id="produktListe">
      {% if produkte %}
        {% for produkt in produkte %}
          <div class="produkt" data-index="{{ loop.index0 }}" data-name="{{ produkt.name }}">
            <div class="produkt-name">{{ produkt.name }}{% if produkt.ablauf %} ‚Äì l√§uft ab am {{ produkt.ablauf }}{% endif %}</div>
            <form method="POST" onsubmit="return confirm('Willst du das Produkt wirklich l√∂schen?');">
              <input type="hidden" name="delete" value="{{ loop.index0 }}" />
              <button type="submit" class="delete-btn">üóëÔ∏è</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <p class="leer">Noch keine Produkte eingetragen</p>
      {% endif %}
    </div>
  {% endif %}
</div>

{% if dev_mode %}
<!-- DEV OVERLAY -->
<div id="devOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:1000;">
  <div style="background:white; width:90%; max-width:500px; border-radius:20px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,0.3); overflow-y:auto; max-height:90%;" role="dialog" aria-modal="true" aria-labelledby="devTitle">
    <h2 id="devTitle" style="text-align:center; margin-bottom:16px; color:#333;">Developer Fenster ‚Äì Benutzerverwaltung</h2>

    <!-- Benutzer hinzuf√ºgen -->
    <form method="POST" style="display:flex; flex-direction:column; gap:12px; margin-bottom:16px;">
      <input type="text" name="new_user" placeholder="Neuer Benutzer" required style="padding:12px; border-radius:14px; border:1px solid #ccc; font-size:1rem;">
      <input type="password" name="new_pass" placeholder="Passwort" required style="padding:12px; border-radius:14px; border:1px solid #ccc; font-size:1rem;">
      <button type="submit" name="add_user" style="padding:12px; border-radius:14px; background:linear-gradient(to right,#4facfe,#00f2fe); color:white; font-weight:600; border:none; cursor:pointer;">‚ûï Benutzer hinzuf√ºgen</button>
    </form>

    <!-- Benutzerliste -->
    <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;">
      {% for u in users %}
        {% if u != "admin" %}
        <li style="background:#f9f9f9; padding:12px; border-radius:14px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.06);">
          <span style="font-weight:500;">{{ u }}</span>
          <form method="POST" style="margin:0;">
            <input type="hidden" name="delete_user" value="{{ u }}">
            <button type="submit" style="border:2px solid red; background:white; color:red; border-radius:12px; padding:6px 12px; cursor:pointer; font-weight:600;">üóëÔ∏è L√∂schen</button>
          </form>
        </li>
        {% endif %}
      {% endfor %}
    </ul>

    <!-- Schlie√üen -->
    <div style="text-align:center; margin-top:20px;">
      <button type="button" id="devCloseBtn" style="padding:10px 20px; background:#eee; border-radius:12px; font-weight:600; border:none; cursor:pointer;">‚ùå Schlie√üen</button>
    </div>
  </div>
</div>

<script>
  // Schlie√üen per Button
  (function () {
    const overlay = document.getElementById('devOverlay');
    const closeBtn = document.getElementById('devCloseBtn');

    function closeOverlay() {
      if (overlay) overlay.remove(); // alternativ: overlay.style.display = 'none';
    }

    if (closeBtn) closeBtn.addEventListener('click', closeOverlay);

    // Klick auf den abgedunkelten Hintergrund schlie√üt
    if (overlay) overlay.addEventListener('click', function (e) {
      if (e.target === overlay) closeOverlay();
    });

    // ESC zum Schlie√üen
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeOverlay();
    });
  })();
</script>
{% endif %}


<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h2>Produkt bearbeiten</h2>
    <form method="POST">
      <input type="hidden" name="edit_index" id="editIndex">
      <input type="text" name="edit_name" id="editName" required>
      <button type="submit" name="edit">üíæ Speichern</button>
    </form>
    <button class="close-btn" onclick="closeModal()">‚úñ Schlie√üen</button>
  </div>
</div>

<!-- AI Recipe Modal -->
<div class="modal" id="recipeModal">
  <div class="modal-content" style="max-width: 600px; text-align: left;">
    <h2 style="text-align: center;">ü§ñ KI Rezept Generator</h2>
    <div id="recipeContent" style="margin: 20px 0; line-height: 1.6;">
      <p style="text-align: center; color: #666;">Laden...</p>
    </div>
    <button class="close-btn" onclick="closeRecipeModal()">‚úñ Schlie√üen</button>
  </div>
</div>

<script>
  // Barcode Scanner
  function onScanSuccess(decodedText) {
    const barcodeInput = document.getElementById("barcode");
    barcodeInput.value = decodedText;
    document.querySelector('input[name="ablauf"]').focus();
    html5QrcodeScanner.clear();
  }
  function onScanFailure(error) {}
  let html5QrcodeScanner = new Html5Qrcode("reader");
  html5QrcodeScanner.start({ facingMode:"environment" }, { fps:10, qrbox:250 }, onScanSuccess, onScanFailure)
    .catch(err => { document.getElementById("reader").innerHTML = "<p style='color:red;text-align:center;'>Kamera nicht verf√ºgbar</p>"; });

  // Live-Suche
  document.getElementById("suche")?.addEventListener("input", function(){
    let filter = this.value.toLowerCase();
    document.querySelectorAll(".produkt").forEach(p => {
      let name = p.querySelector(".produkt-name").textContent.toLowerCase();
      p.style.display = name.includes(filter) ? "flex" : "none";
    });
  });

  // Edit Modal
  const modal = document.getElementById("editModal");
  const editNameInput = document.getElementById("editName");
  const editIndexInput = document.getElementById("editIndex");
  document.querySelectorAll(".produkt")?.forEach(p => {
    p.addEventListener("click", e => {
      if(e.target.closest("form")) return;
      editNameInput.value = p.dataset.name;
      editIndexInput.value = p.dataset.index;
      modal.style.display = "flex";
    });
  });
  function closeModal(){ modal.style.display="none"; }
  window.onclick = event => { if(event.target==modal) closeModal(); }

  // Plus Button
  const manualBtn = document.getElementById("manualBtn");
  const manualName = document.getElementById("manualName");
  const barcodeInput = document.getElementById("barcode");
  const form = document.getElementById("form");

  manualBtn?.addEventListener("click", ()=>{
    if(manualName.style.display==="none"){ manualName.style.display="block"; barcodeInput.disabled=true; manualName.focus(); }
    else{ manualName.style.display="none"; barcodeInput.disabled=false; barcodeInput.focus(); }
  });
  form?.addEventListener("submit", function(){ const manualValue = manualName.value.trim(); if(manualValue){ barcodeInput.value = manualValue; } });

  // AI Recipe Generator
  const recipeModal = document.getElementById("recipeModal");
  const recipeContent = document.getElementById("recipeContent");
  const aiRecipeBtn = document.getElementById("aiRecipeBtn");

  function closeRecipeModal() {
    recipeModal.style.display = "none";
  }

  aiRecipeBtn?.addEventListener("click", async function() {
    recipeModal.style.display = "flex";
    recipeContent.innerHTML = '<p style="text-align: center; color: #666;">üîÑ Generiere Rezept...</p>';

    try {
      const response = await fetch('/api/generate-recipe');
      const data = await response.json();

      if (data.success) {
        recipeContent.innerHTML = `
          <h3 style="color: #ff6b6b; margin-bottom: 10px;">üìñ ${data.recipe.title}</h3>
          <p style="color: #666; font-style: italic; margin-bottom: 15px;">${data.recipe.description}</p>

          <h4 style="color: #333; margin-top: 20px;">ü•ò Zutaten:</h4>
          <ul style="list-style: none; padding-left: 0;">
            ${data.recipe.ingredients.map(ing => `<li style="padding: 5px 0; border-bottom: 1px solid #eee;">‚Ä¢ ${ing}</li>`).join('')}
          </ul>

          <h4 style="color: #333; margin-top: 20px;">üë®‚Äçüç≥ Zubereitung:</h4>
          <ol style="padding-left: 20px;">
            ${data.recipe.steps.map(step => `<li style="padding: 8px 0;">${step}</li>`).join('')}
          </ol>

          <p style="margin-top: 20px; padding: 10px; background: #f0f8ff; border-radius: 10px; font-size: 0.9em;">
            <strong>‚è±Ô∏è Zubereitungszeit:</strong> ${data.recipe.time}<br>
            <strong>üë• Portionen:</strong> ${data.recipe.servings}
          </p>
        `;
      } else {
        recipeContent.innerHTML = `<p style="color: red; text-align: center;">${data.message}</p>`;
      }
    } catch (error) {
      recipeContent.innerHTML = '<p style="color: red; text-align: center;">Fehler beim Generieren des Rezepts. Bitte versuchen Sie es sp√§ter erneut.</p>';
    }
  });

  window.onclick = event => {
    if(event.target==modal) closeModal();
    if(event.target==recipeModal) closeRecipeModal();
  }
</script>
</body>
</html>